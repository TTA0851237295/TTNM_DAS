<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DAS Học Lập Trình Để Đi Làm</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.10.0/font/bootstrap-icons.min.css" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">
    <style>
        /* Các style modal và form thanh toán */
        .custom-modal {
            display: none;
            position: fixed;
            z-index: 9999;
            left: 0; top: 0;
            width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.4);
            align-items: center;
            justify-content: center;
        }

        .custom-modal-content {
            background-color: #fff;
            margin: 10% auto;
            padding: 20px 30px;
            border: 1px solid #888;
            width: 350px;
            border-radius: 8px;
            position: relative;
            font-family: sans-serif;
            text-align: center;
            box-shadow: 0 0 10px #00000020;
        }

        .custom-modall-content {
            background-color: #fff;
            margin: 10% auto;
            padding: 20px 30px;
            border: 1px solid #888;
            width: 900px;
            border-radius: 8px;
            position: relative;
            font-family: sans-serif;
            text-align: center;
            box-shadow: 0 0 10px #00000020;
        }

        .custom-close {
            position: absolute;
            right: 12px;
            top: 10px;
            font-size: 18px;
            cursor: pointer;
            font-weight: bold;
        }

        .custom-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1rem;
            font-weight: bold;
            color: #000;
        }

        /* Style cho form thanh toán */
        .checkout-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .info-block {
            background: #f2f2f2;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 15px;
        }

        .btn-outline-primary {
            background-color: white !important;
            color: black !important;
            border-color: #ccc !important;
        }

        .btn-outline-primary.active {
            background-color: #ff4171 !important;
            color: white !important;
            border-color: #ea406a !important;
        }

        .btn-outline-primary:hover {
            background-color: #eee;
        }

        .btn-checkout {
            background: red;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 600;
            transition: background-color 0.3s ease;
        }

        .btn-checkout:hover {
            background: #d63384;
            color: white;
        }

        .is-invalid {
            border-color: #dc3545;
        }

        .text-danger {
            color: #dc3545;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg">
        <div class="container-fluid">
            <a class="navbar-brand d-flex align-items-center" href="#">
                <img src="img/logo.png" alt="DAS Logo" class="logo">
                
            </a>
            <div class="navbar-brand d-flex align-items-center">DAS Học Lập Trình Để Đi Làm</div>
            
            <div class="search-box mx-auto">
                <div class="position-relative">
                    <i class="bi bi-search search-icon"></i>
                    <input type="text" class="form-control" placeholder="Tìm kiếm khóa học..." id="searchInput">
                </div>
            </div>
            
            <div class="user-info">
                <i class="bi bi-bell"></i>
                <span>Tuấn Anh</span>
                <i class="bi bi-person-circle fs-4"></i>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <div class="col-md-3 col-lg-2 sidebar">
                <a href="index.html" class="sidebar-item">
                    <i class="bi bi-house-door-fill sidebar-icon"></i>
                    <span>Trang chủ</span>
                </a>
                <a href="Giohang.html" class="sidebar-item">
                    <i class="bi bi-cart3 sidebar-icon"></i>
                    <span>Giỏ hàng</span>
                </a>
                <a href="my-courses.html" class="sidebar-item">
                    <i class="bi bi-book sidebar-icon"></i>
                    <span>Khóa học</span>
                </a>
            </div>

            <div class="col-md-9 col-lg-10 main-content">
                <h1 class="page-title">Thông tin thanh toán</h1>
                
                <div class="mb-3">
                    <a href="Giohang.html" class="btn btn-outline-secondary">
                        ← Quay lại giỏ hàng
                    </a>
                </div>

                <div class="checkout-container">
                    <form id="checkoutForm">
                        <div class="mb-3">
                            <strong>Thông tin khách hàng</strong>
                        </div>

                        <div class="info-block">
                            <div class="mb-2" style="display: flex; align-items: center; margin-bottom: 10px;">
                                <label for="customerId" class="form-label" style="min-width: 90px; margin-right: 10px;">Mã KH:</label>
                                <input type="text" class="form-control form-control-sm" style="max-width: 850px;" id="customerId" name="customerId">
                            </div>
                            <div class="text-danger small" id="errorCustomerId" style="display:none; margin-left: 100px;">Vui lòng nhập mã khách hàng.</div>

                            <div class="mb-2" style="display: flex; align-items: center; margin-bottom: 10px;">
                                <label for="fullName" class="form-label" style="min-width: 90px; margin-right: 10px;">Họ tên:</label>
                                <input type="text" class="form-control form-control-sm" style="max-width: 850px;" id="fullName" name="fullName">
                            </div>
                            <div class="text-danger small" id="errorFullName" style="display:none; margin-left: 100px;">Vui lòng nhập họ tên.</div>

                            <div class="mb-2" style="display: flex; align-items: center; margin-bottom: 10px;">
                                <label for="email" class="form-label" style="min-width: 90px; margin-right: 10px;">Email:</label>
                                <input type="email" class="form-control form-control-sm" style="max-width: 850px;" id="email" name="email">
                            </div>
                            <div class="text-danger small" id="errorEmail" style="display:none; margin-left: 100px;">Vui lòng nhập email.</div>
                        </div>

                        <div style="background: #f2f2f2; padding: 10px; border-radius: 5px; margin-bottom: 10px; font-size: 0.9rem; max-width: 100%;">
                            <table class="table mb-0">
                                <thead>
                                    <tr>
                                        <th>Sản phẩm</th>
                                        <th>Đơn giá</th>
                                        <th>Thành tiền</th>
                                    </tr>
                                </thead>
                                <tbody id="orderTableBody">
                                    </tbody>
                            </table>
                        </div>

                        <div style="background: #f2f2f2; padding: 10px; border-radius: 5px; margin-bottom: 10px; font-size: 0.9rem; max-width: 100%;">
                            <div class="mb-2">
                                <strong>Phương thức thanh toán:</strong>
                                <div class="btn-group ms-2" role="group">
                                    <button type="button" class="btn btn-outline-primary" onclick="selectPayment(this, 'credit')">Thẻ tín dụng</button>
                                    <button type="button" class="btn btn-outline-primary" onclick="selectPayment(this, 'bank')">Chuyển khoản</button>
                                </div>
                                <input type="hidden" name="payment" id="paymentMethod">
                            </div>
                        </div>

                        <div class="row align-items-center mt-4">
                            <div class="col-md-6">
                                <span id="totalCourses" class="fw-bold fs-5">Tổng cộng:</span> 
                                <span id="totalAmount" class="text-danger fw-bold fs-5">0đ</span>
                            </div>
                            <div class="col-md-6 text-end">
                                <button type="submit" class="btn btn-checkout px-6 py-3">Thanh Toán</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <footer class="footer">
        </footer>

    <div id="creditFormOverlay" style="display: none; position: fixed; top: 0; left: 0; 
      width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); z-index: 9999;">
      
      <div style="width: 750px; margin: 60px auto; background: #ccc; padding: 30px; border-radius: 5px; position: relative;">
        <div style="display: flex; align-items: center; margin-bottom: 20px;">
          <button type="button" onclick="hideCreditForm()" style="border: none; background: none; font-size: 18px; cursor: pointer;">←</button>
          <strong style="margin-left: 10px;">Thanh toán qua thẻ tín dụng</strong>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
          <div><label>Số thẻ *</label><input type="text" id="cardNumber" class="form-control"></div>
          <div><label>Ngày hết hạn *</label><input type="text" id="expiryDate" class="form-control"></div>
          <div><label>Tháng/Năm phát hành *</label><input type="text" id="issueDate" class="form-control"></div>
          <div><label>Tên chủ thẻ (không dấu) *</label><input type="text" id="cardHolder" class="form-control"></div>
          <div><label>Mã PIN *</label><input type="password" id="cardPin" class="form-control"></div>
        </div>
        <div style="text-align: center; margin-top: 25px;"><p style="color: red; font-size: 0.9rem;">* Thông tin bắt buộc</p></div>
        <div style="text-align: right;"><button onclick="validateCreditForm()" style="background: #e74c3c; color: white; border: none; padding: 8px 20px; border-radius: 3px;">Xác nhận</button></div>
      </div>
    </div>

    <div id="paymentMethodModal" class="custom-modal"><div class="custom-modal-content"><div class="custom-modal-header"><span class="modal-title">Thông báo</span><span class="custom-close" onclick="closePaymentMethodModal()">&#10006;</span></div><hr class="modal-divider" /><p class="modal-message">Vui lòng chọn phương thức thanh toán</p></div></div>
    <div id="creditInfoModal" class="custom-modal"><div class="custom-modal-content"><div class="custom-modal-header"><span class="modal-title">Thông báo</span><span class="custom-close" onclick="closeCreditInfoModal()">&#10006;</span></div><hr class="modal-divider" /><p class="modal-message">Vui lòng điền đầy đủ thông tin thẻ tín dụng!</p></div></div>
    <div id="successModal" class="custom-modal"><div class="custom-modal-content"><div class="custom-modal-header"><span class="modal-title">Thanh toán</span><span class="custom-close" onclick="closeSuccessModal()">&#10006;</span></div><hr class="modal-divider" /><p class="modal-message ">Thanh toán thành công qua thẻ tín dụng!</p></div></div>
    <div id="bankTransferModal" class="custom-modal"><div class="custom-modall-content" style="max-width: 1000px; padding: 30px; border-radius: 16px; background: #fff;"><div style="display: flex; align-items: center; margin-bottom: 20px;"><button type="button" onclick="closeBankModal()" style="border: none; background: none; font-size: 22px; cursor: pointer;">←</button><strong style="margin-left: 12px; font-size: 20px;">Thanh toán qua mã QR</strong></div><p style="text-align: center; margin-bottom: 30px; font-size: 16px;">Quét mã để thanh toán - DAS</p><div style="display: flex; gap: 60px; align-items: center; justify-content: center;"><div style="flex: 0 0 320px;"><img src="https://i.imgur.com/RiAGqEI.png" alt="QR Code" style="width: 100%; border-radius: 16px;" /></div><div style="flex: 1; font-size: 18px; text-align: left;"><div style="margin-bottom: 12px;"><strong>Ngân hàng:</strong> MBBANK</div><div style="margin-bottom: 12px;"><strong>Số tiền:</strong> 1.000.000 VND</div><div style="margin-bottom: 12px;"><strong>STK:</strong> 01122446123</div><div><strong>Tên tài khoản:</strong> PHAM TUAN ANH</div></div></div></div></div>
    <div id="bankSuccessModal" class="custom-modal" style="display: none;"><div class="custom-modal-content" style="max-width: 400px; background: #fff; border-radius: 12px; padding: 20px; margin-top: 300px;"><div class="custom-modal-header" style="display: flex; justify-content: space-between; align-items: center;"><span class="modal-title">Thông báo</span><span class="custom-close" onclick="closebankSuccessModal()" style="cursor: pointer;">&#10006;</span></div><hr class="modal-divider" /><p style="font-size: 16px; color: black; margin-top: 10px;">Thanh toán thành công qua mã QR!</p></div></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
    // ===================================
    // CÁC HÀM ĐÃ SỬA LẠI - BẮT ĐẦU
    // ===================================
    
    // HÀM MỚI: Xử lý logic chung sau khi mua hàng thành công
    function processSuccessfulPurchase() {
        // Lấy các khóa học đang trong quá trình thanh toán
        const coursesToPurchase = JSON.parse(localStorage.getItem('selectedCourses')) || [];

        if (coursesToPurchase.length > 0) {
            // Lấy danh sách các khóa học đã mua trước đó
            let myCourses = JSON.parse(localStorage.getItem('myCourses')) || [];
            
            // Lấy danh sách giỏ hàng gốc
            let cart = JSON.parse(localStorage.getItem('cart')) || [];

            coursesToPurchase.forEach(newCourse => {
                // Kiểm tra để không thêm khóa học trùng lặp bằng ID
                const isAlreadyPurchased = myCourses.some(myCourse => myCourse.id === newCourse.id);
                if (!isAlreadyPurchased) {
                    myCourses.push(newCourse);
                }
                
                // Xóa khóa học đã mua khỏi giỏ hàng gốc bằng ID
                cart = cart.filter(cartItem => cartItem.id !== newCourse.id);
            });

            // Lưu lại danh sách khóa học của tôi và giỏ hàng mới
            localStorage.setItem('myCourses', JSON.stringify(myCourses));
            localStorage.setItem('cart', JSON.stringify(cart));

            // Dọn dẹp các khóa học đang chọn
            localStorage.removeItem('selectedCourses');
        }
    }

    // SỬA LẠI: Hàm xác thực form thẻ tín dụng
    function validateCreditForm() {
        const cardNumber = document.getElementById('cardNumber').value.trim();
        const expiryDate = document.getElementById('expiryDate').value.trim();
        const issueDate = document.getElementById('issueDate').value.trim();
        const cardHolder = document.getElementById('cardHolder').value.trim();
        const cardPin = document.getElementById('cardPin').value.trim();

        if (!cardNumber || !expiryDate || !issueDate || !cardHolder || !cardPin) {
            showCreditInfoModal();
            return;
        }

        processSuccessfulPurchase(); // <-- GỌI HÀM XỬ LÝ
        hideCreditForm();
        showSuccessModal();
    }

    // SỬA LẠI: Hàm hiển thị modal thành công của chuyển khoản
    function showbankSuccessModal() {
        processSuccessfulPurchase(); // <-- GỌI HÀM XỬ LÝ

        document.getElementById('bankTransferModal').style.display = 'none';
        document.getElementById("bankSuccessModal").style.display = "block";
    }
    
    // SỬA LẠI: Hàm đóng modal thẻ tín dụng và chuyển hướng
    function closeSuccessModal() {
        document.getElementById('successModal').style.display = 'none';
        window.location.href = "my-courses.html"; // Chuyển đến trang Khóa học của tôi
    }
    
    // SỬA LẠI: Hàm đóng modal chuyển khoản và chuyển hướng
    function closebankSuccessModal() {
        document.getElementById("bankSuccessModal").style.display = "none";
        window.location.href = "my-courses.html"; // Chuyển đến trang Khóa học của tôi
    }

    // ===================================
    // CÁC HÀM GỐC - KHÔNG SỬA
    // ===================================

    window.onload = function () {
        const courseData = JSON.parse(localStorage.getItem('selectedCourses')) || [];
        const tbody = document.querySelector("table tbody");
        if (!tbody) return;
        tbody.innerHTML = "";

        let total = 0;

        courseData.forEach(item => {
            const row = document.createElement("tr");
            const titleCell = document.createElement("td");
            titleCell.textContent = item.title;
            const priceCell = document.createElement("td");
            priceCell.textContent = item.currentPrice; // Sửa lại để lấy giá đúng
            const totalCell = document.createElement("td");
            totalCell.textContent = item.currentPrice; // Sửa lại để lấy giá đúng

            row.appendChild(titleCell);
            row.appendChild(priceCell);
            row.appendChild(totalCell);
            tbody.appendChild(row);

            const num = parseInt(item.currentPrice.replace(/\D/g, ""), 10);
            total += isNaN(num) ? 0 : num;
        });

        document.getElementById("totalCourses").textContent = `Tổng cộng (${courseData.length} khóa học):`;
        document.getElementById("totalAmount").textContent = total.toLocaleString('vi-VN') + "đ";
    };

    function selectPayment(element, method) {
        document.querySelectorAll('.btn-outline-primary').forEach(b => b.classList.remove('active'));
        element.classList.add('active');
        document.getElementById('paymentMethod').value = method;
    }

    document.getElementById('checkoutForm').addEventListener('submit', function(event) {
        event.preventDefault();
        let valid = true;

        const customerId = document.getElementById('customerId');
        const fullName = document.getElementById('fullName');
        const email = document.getElementById('email');
        const paymentMethod = document.getElementById('paymentMethod').value;

        // Reset error displays
        document.getElementById('errorCustomerId').style.display = 'none';
        document.getElementById('errorFullName').style.display = 'none';
        document.getElementById('errorEmail').style.display = 'none';
        customerId.classList.remove('is-invalid');
        fullName.classList.remove('is-invalid');
        email.classList.remove('is-invalid');

        if (!customerId.value.trim()) {
            document.getElementById('errorCustomerId').style.display = 'block';
            customerId.classList.add('is-invalid');
            valid = false;
        }
        if (!fullName.value.trim()) {
            document.getElementById('errorFullName').style.display = 'block';
            fullName.classList.add('is-invalid');
            valid = false;
        }
        if (!email.value.trim()) {
            document.getElementById('errorEmail').style.display = 'block';
            email.classList.add('is-invalid');
            valid = false;
        }
        
        if(!valid) return;

        if (!paymentMethod) {
            showPaymentMethodModal();
            return;
        }

        if (paymentMethod === "credit") {
            showCreditForm();
        } else if (paymentMethod === "bank") {
            showBankModal();
        }
    });

    function showCreditForm() {
        document.getElementById('creditFormOverlay').style.display = 'flex';
    }

    function hideCreditForm() {
        document.getElementById('creditFormOverlay').style.display = 'none';
    }

    function showPaymentMethodModal() { document.getElementById('paymentMethodModal').style.display = 'flex'; }
    function closePaymentMethodModal() { document.getElementById('paymentMethodModal').style.display = 'none'; }
    function showCreditInfoModal() { document.getElementById('creditInfoModal').style.display = 'flex'; }
    function closeCreditInfoModal() { document.getElementById('creditInfoModal').style.display = 'none'; }
    function showSuccessModal() { document.getElementById('successModal').style.display = 'flex'; }
    function showBankModal() {
        document.getElementById('bankTransferModal').style.display = 'flex';
        setTimeout(showbankSuccessModal, 3000); // Giảm thời gian chờ
    }
    function closeBankModal() { document.getElementById('bankTransferModal').style.display = 'none'; }
</script>

</body>
</html>